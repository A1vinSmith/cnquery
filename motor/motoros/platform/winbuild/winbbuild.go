package winbuild

import (
	"fmt"
	"regexp"
	"strconv"
)

var WinBuildVersionRegex = regexp.MustCompile(`^(\d+)(?:\.(\d+)){0,1}`)

type BuildVersion struct {
	Build int
	UBR   int
}

// WindowsVersion parses the version generated by motor
// It uses the format: major.minor.build.ubr
func Version(ver string) (*BuildVersion, error) {
	// check that we go a valid windows version
	m := WinBuildVersionRegex.FindStringSubmatch(ver)
	if len(m) < 2 {
		return nil, fmt.Errorf("the requested windows version is not supported: %s", ver)
	}

	build, err := strconv.Atoi(m[1])
	if err != nil {
		return nil, err
	}

	var ubr int
	if len(m) == 3 && len(m[2]) > 0 {
		ubr, err = strconv.Atoi(m[2])
		if err != nil {
			return nil, err
		}
	}

	return &BuildVersion{
		Build: build,
		UBR:   ubr,
	}, nil
}

func (b BuildVersion) OSBuild() string {
	if b.UBR > 0 {
		return fmt.Sprintf("%d.%d", b.Build, b.UBR)
	} else {
		return fmt.Sprintf("%d", b.Build)
	}
}
